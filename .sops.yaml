# I'm using YAML references here to make the format a bit more managable. SOPS doesn't support
# specifying multiple AGE public keys with a list... They need to be inline and comma delimited so I
# specify them with a bit more friendly of a name to make auditing and re-use a little but easier
# to handle.

# These keys will be granted access to all of the secrets for any of the manifests within this
# directory. Our human users should have their FIDO2 public key (generated by age-plugin-fido2-hmac)
# in this list as well as the CD service which will be keeping it up to date. A user's identity
# handle for their FIDO2 key should be stored matching their system login username (as reported by
# `whoami`) in `secrets/identities/$(whoami).handle` file.
#
# The keys present in this list are in order:
#
# - sstelfox
# - argocd:secrets/{CLUSTER_NAME}/argocd.pub
x-manifest-keys: &manifest-keys >-
  age1a5344plx2p7ar9f2xg4ewmkxn0sppqqm633cafth20kgxtefpeyqgm9fa3,
  age1g3h5t4vlvqfgwdlaqqwrkss2sjzp0uy9fw2cfufrgekjdm6gk44qdc90az

# Ultimate keys to the kingdom. Key material protected with these keys should only be needed during
# cluster initialization and during any disaster recovery event. This include sensitive information
# such as the Vault root unsealing key, copies of private keys for the other services present here.
# Unauthorized access to this requires rotating all key material in the cluster.
#
# The keys present in this list are in order:
#
# - sstelfox
x-root-keys: &root-keys >-
  age1a5344plx2p7ar9f2xg4ewmkxn0sppqqm633cafth20kgxtefpeyqgm9fa3

# * Ensure most specific paths are specified in this file before less specific ones
# * Provide the minimum access necessary for each key, keys are cheap and easy to manage. Rotating
#   many credentials is less fun.
creation_rules:
  # Rule for general manifest secrets, needs to be accessible by anyone writing secrets. If there
  # was a large team working with these it would be worth getting more fine grained with the access
  # grouping here based on responsibilities.
  - path_regex: manifests/.*/secrets\.yaml$
    age: *manifest-keys

  # These are encrypted copies of the private keys used by the automated services specified
  # elsewhere in this file (such as the ArgoCD keys). These should only need to be retrieved during
  # cluster initialization and during a DR event. The keys can be rotated without having access.
  - path_regex: secrets/.*/.*\.key$
    age: *root-keys
